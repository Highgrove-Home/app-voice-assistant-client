name: Deploy Voice Assistant Client

on:
  push:
    branches: [main]
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: [self-hosted, voice-assistant-client]
    steps:
      - name: Setup application directory
        shell: bash
        run: |
          APP_DIR="/opt/voice-assistant-client"

          if [ ! -d "$APP_DIR" ]; then
            echo "Creating $APP_DIR..."
            sudo mkdir -p "$APP_DIR"
            sudo chown -R $USER:$USER "$APP_DIR"

            echo "Cloning repository..."
            git clone https://github.com/Highgrove-Home/app-voice-assistant-client "$APP_DIR"
          else
            echo "Updating existing repository..."
            cd "$APP_DIR"
            git fetch origin
            git checkout main
            git pull --ff-only
          fi

      - name: Install dependencies
        shell: bash
        run: |
          cd /opt/voice-assistant-client
          uv python install 3.9
          uv python pin 3.9
          uv sync

      - name: Ensure service exists
        shell: bash
        run: |
          SERVICE_FILE="/etc/systemd/system/voice-assistant-client.service"
          ENV_FILE="/etc/voice-assistant-client.env"

          # Create env file if missing
          if [ ! -f "$ENV_FILE" ]; then
            echo "Creating $ENV_FILE with defaults..."
            sudo tee "$ENV_FILE" >/dev/null <<'EOF'
          ROOM=unknown
          PIPECAT_SERVER=http://pi-voice.local:7860
          ALSA_DEVICE=plughw:1,0
          EOF
            sudo chmod 0644 "$ENV_FILE"
            echo "⚠️  WARNING: Edit $ENV_FILE to set correct ROOM and ALSA_DEVICE"
          fi

          # Create or update service file to ensure unbuffered output
          echo "Creating/updating systemd service..."
          sudo tee "$SERVICE_FILE" >/dev/null <<EOF
          [Unit]
          Description=Voice Assistant Client
          After=network-online.target sound.target
          Wants=network-online.target

          [Service]
          Type=simple
          User=$USER
          WorkingDirectory=/opt/voice-assistant-client
          EnvironmentFile=$ENV_FILE
          Environment=PATH=$HOME/.local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
          Environment=PYTHONUNBUFFERED=1
          ExecStart=/usr/bin/env bash -lc 'cd /opt/voice-assistant-client && uv run python -u client.py'
          Restart=always
          RestartSec=2
          StandardOutput=journal
          StandardError=journal

          [Install]
          WantedBy=multi-user.target
          EOF
          sudo systemctl daemon-reload
          if ! systemctl is-enabled voice-assistant-client >/dev/null 2>&1; then
            sudo systemctl enable voice-assistant-client
          fi
          echo "✅ Service updated"

      - name: Restart service
        run: |
          sudo /usr/bin/systemctl restart voice-assistant-client
          sudo /usr/bin/systemctl --no-pager --full status voice-assistant-client